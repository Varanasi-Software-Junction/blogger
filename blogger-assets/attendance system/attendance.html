<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Directional Face Counter – Left/Right</title>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.9.0/dist/tf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>

<style>
    body { background:#fff4d0; font-family:sans-serif; text-align:center; padding:20px; }
    #canvas { border:3px solid #c68a00; border-radius:12px; margin-top:20px; }
    button { padding:10px 20px; font-size:18px; margin:10px; }
</style>
</head>
<body>

<h2>Directional Face Counter (Left / Right Crossing)</h2>

<button onclick="startDetector()">Start</button>
<button onclick="stopDetector()">Stop</button>

<br>

<canvas id="canvas" width="640" height="480"></canvas>

<h2 id="countText">People Count: 0</h2>

<script>
let model, video, stream, running = false;
let personCount = 0;

// Track previous X position of the face
let lastFaceX = null;

const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

// Vertical center line
const centerX = canvas.width / 2;

async function startDetector() {
    if (running) return;
    running = true;

    if (!model) model = await blazeface.load();

    video = document.createElement("video");
    stream = await navigator.mediaDevices.getUserMedia({ video:true });
    video.srcObject = stream;
    await video.play();

    requestAnimationFrame(loop);
}

function stopDetector() {
    running = false;
    if (stream) stream.getTracks().forEach(t => t.stop());
    ctx.clearRect(0,0,canvas.width,canvas.height);
    document.getElementById("countText").innerText = "People Count: 0";
}

async function loop() {
    if (!running) return;

    ctx.drawImage(video,0,0,canvas.width,canvas.height);

    // Draw vertical red center line
    ctx.strokeStyle = "red";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(centerX, 0);
    ctx.lineTo(centerX, canvas.height);
    ctx.stroke();

    const predictions = await model.estimateFaces(video, false);

    if (predictions.length > 0) {
        const p = predictions[0];  // track only first face

        const [x, y] = p.topLeft;
        const [x2, y2] = p.bottomRight;
        const faceX = (x + x2) / 2;  // center X of face

        // Draw box
        ctx.strokeStyle = "#ff9800";
        ctx.lineWidth = 3;
        ctx.strokeRect(x, y, x2 - x, y2 - y);

        // Direction detection (left-right crossing)
        if (lastFaceX !== null) {

            // Moving LEFT → RIGHT across the center line
            if (lastFaceX < centerX && faceX > centerX) {
                personCount++;
            }

            // Moving RIGHT → LEFT across the center line
            if (lastFaceX > centerX && faceX < centerX) {
                personCount--;
                if (personCount < 0) personCount = 0;
            }
        }

        lastFaceX = faceX;
    }

    document.getElementById("countText").innerText =
        "People Count: " + personCount;

    requestAnimationFrame(loop);
}
</script>

</body>
</html>
