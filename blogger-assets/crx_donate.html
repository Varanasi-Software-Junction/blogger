<!-- crx_donate.html - Fixed: anchors use data-upi + href -> QR fallback so desktop won't try to open upi:// -->
<div class="crx_donate_card" role="region" aria-label="Support this blog - donate" id="crx_donate_fragment">
  <style>
    .crx_donate_card{ font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; max-width:520px; margin:12px 0; padding:12px; border-radius:12px; box-shadow:0 6px 18px rgba(11,12,16,0.06); background:linear-gradient(180deg,#ffffff,#fbfdff); display:flex; gap:12px; align-items:center; }
    .crx_donate_qr{ width:110px; height:110px; border-radius:8px; background:#f3f4f6; display:flex; align-items:center; justify-content:center; overflow:hidden; flex-shrink:0; }
    .crx_donate_qr img{ width:100%; height:100%; object-fit:contain; display:block; }
    .crx_donate_meta{ flex:1; min-width:0; }
    .crx_donate_title{ font-size:17px; font-weight:800; margin-bottom:6px; color:#071022; }
    .crx_donate_desc{ font-size:14px; color:#6b7280; line-height:1.35; margin-bottom:8px; }
    .crx_donate_benefits{ font-size:13px; color:#39404a; margin-bottom:10px; }
    .crx_action_row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .crx_btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; text-decoration:none; font-weight:700; border:1px solid rgba(0,0,0,0.06); cursor:pointer; background:#fff; color:#071022; }
    .crx_primary{ background:#0b84ff; color:#fff; box-shadow:0 8px 20px rgba(11,132,255,0.12); }
    .crx_preset{ display:inline-flex; text-decoration:none; align-items:center; justify-content:center; background:#f4f7fb; padding:8px 10px; border-radius:8px; font-weight:800; color:#071022; border:0; cursor:pointer; }
    .crx_small_hint{ font-size:12px; color:#6b7280; margin-top:8px; }
    .crx_donate_smallprint{ font-size:12px; color:#6b7280; margin-top:8px; }
    @media (max-width:520px){ .crx_donate_card{ max-width:96%; } .crx_donate_qr{ width:96px; height:96px; } }
  </style>

  <div class="crx_donate_qr" aria-hidden="false">
    <img src="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg" alt="QR code to donate" loading="lazy" decoding="async" width="110" height="110" />
  </div>

  <div class="crx_donate_meta">
    <div class="crx_donate_title">Support Learning Sutras — small donations, big impact</div>
    <div class="crx_donate_desc">If this post helped you, please consider supporting my writing. Choose a quick amount or open the QR — thank you ❤️</div>

    <div class="crx_donate_benefits">Quick options — keeps tools free, fewer ads, and funds new tutorials.</div>

    <div class="crx_action_row" role="group" aria-label="Donation actions">
      <!-- IMPORTANT: href points to QR fallback (works on desktop) -->
      <a id="crx_pay_now" class="crx_btn crx_primary"
         href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg"
         data-upi="upi://pay?pa=champaksworld%40okicici&pn=Champak%20Roy&am=50&cu=INR"
         rel="noopener" aria-label="Donate ₹50 now">Donate ₹50</a>

      <!-- Preset anchors: href -> QR fallback; data-upi -> actual deep-link used on mobile -->
      <a class="crx_preset" href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg"
         data-upi="upi://pay?pa=champaksworld%40okicici&pn=Champak%20Roy&am=20&cu=INR"
         data-amount="20" aria-label="Donate ₹20">₹20</a>

      <a class="crx_preset" href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg"
         data-upi="upi://pay?pa=champaksworld%40okicici&pn=Champak%20Roy&am=50&cu=INR"
         data-amount="50" aria-label="Donate ₹50">₹50</a>

      <a class="crx_preset" href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg"
         data-upi="upi://pay?pa=champaksworld%40okicici&pn=Champak%20Roy&am=100&cu=INR"
         data-amount="100" aria-label="Donate ₹100">₹100</a>

      <a class="crx_preset" href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg"
         data-upi="upi://pay?pa=champaksworld%40okicici&pn=Champak%20Roy&am=250&cu=INR"
         data-amount="250" aria-label="Donate ₹250">₹250</a>

      <!-- QR fallback link -->
      <a id="crx_open_qr" class="crx_btn" href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg" target="_blank" rel="noopener noreferrer" aria-label="Open QR code in new tab">Open QR — Save/Scan</a>
    </div>

    <div class="crx_small_hint">Tip: on mobile, tapping a Donate link should open your UPI app. On desktop it opens the QR image to scan.</div>
    <div class="crx_donate_smallprint">You’ll stay anonymous unless you choose to share details. Thanks — Anita Rai w/o Champak</div>
  </div>
</div>

<!-- Floating button (keeps previous behavior) -->
<style>
#crx_floating_donate{ position:fixed; z-index:9998; --size:64px; width:var(--size); height:var(--size); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(3,10,30,0.18); background:linear-gradient(180deg,#0b84ff,#0466d7); color:white; font-weight:700; cursor:pointer; border:0; transition:transform 350ms ease, opacity 300ms ease, right 1s ease, left 1s ease, bottom 1s ease, top 1s ease; opacity:0; pointer-events:none; }
#crx_floating_donate.visible{ opacity:1; pointer-events:auto; }
#crx_floating_label{ position:fixed; z-index:9997; background:#fff; color:#071022; padding:8px 10px; border-radius:8px; box-shadow:0 8px 20px rgba(6,12,22,0.12); font-weight:700; font-size:13px; transition:opacity 200ms, transform 200ms; opacity:0; pointer-events:none; }
#crx_floating_donate:hover + #crx_floating_label, #crx_floating_donate:focus + #crx_floating_label{ opacity:1; transform:translateY(-6px); }
#crx_floating_dismiss{ position:absolute; right:-8px; top:-8px; width:22px; height:22px; border-radius:50%; background:rgba(0,0,0,0.12); color:#fff; font-size:12px; display:flex; align-items:center; justify-content:center; border:0; transition:opacity .15s; }
#crx_floating_donate:hover #crx_floating_dismiss{ opacity:1; }
@media (prefers-reduced-motion: reduce){ #crx_floating_donate, #crx_floating_label{ transition:none!important; } }
</style>

<button id="crx_floating_donate" aria-label="Donate — open UPI or QR" title="Donate — open UPI or QR" aria-haspopup="dialog" type="button">
  Donate
  <button id="crx_floating_dismiss" aria-label="Close donate button" title="Close" type="button">✕</button>
</button>
<div id="crx_floating_label" role="status" aria-live="polite">Donate via UPI</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const QR = 'https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg';
  const presetAnchors = Array.from(document.querySelectorAll('.crx_preset'));
  const payNow = document.getElementById('crx_pay_now');
  const openQr = document.getElementById('crx_open_qr');
  const btn = document.getElementById('crx_floating_donate');
  const dismissBtn = document.getElementById('crx_floating_dismiss');

  // helper to detect phone browsers (heuristic)
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  function handleAnchorClick(e, anchor){
    const upi = anchor.getAttribute('data-upi');
    if(!upi) return; // nothing special
    if(isMobile){
      // allow default navigation to href for compatibility while also attempting deep link
      // use location.href to try to open the upi handler (works in most mobile browsers)
      // but don't prevent default because some browsers handle anchors differently
      setTimeout(()=> {
        try {
          location.href = upi;
        } catch(err) {
          // fallback: open QR image
          window.open(QR, '_blank', 'noopener');
        }
      }, 200);
      // don't preventDefault - let anchor also open QR href if desired on some devices
    } else {
      // Desktop: prevent trying to open upi: scheme (which causes the "no handler" error)
      e.preventDefault();
      // open QR so desktop users can scan
      window.open(QR, '_blank', 'noopener');
    }
  }

  // attach to primary Donate anchor
  if(payNow){
    payNow.addEventListener('click', function(e){ handleAnchorClick(e, payNow); });
  }
  // attach to preset anchors
  presetAnchors.forEach(a => a.addEventListener('click', function(e){ handleAnchorClick(e, a); }));

  // Open QR link (already opens QR) - nothing to change
  if(openQr){
    openQr.addEventListener('click', function(){ /* default behaviour: open QR in new tab */ });
  }

  // Floating button: trigger primary anchor click (won't call upi on desktop, will open QR)
  if(btn){
    btn.addEventListener('click', function(e){
      if(e.target && e.target.id === 'crx_floating_dismiss') return;
      if(payNow){
        // trigger the same behaviour as clicking the Donate anchor
        payNow.click();
      } else {
        window.open(QR, '_blank', 'noopener');
      }
    });
  }
  // dismiss behavior (hide for days)
  if(dismissBtn){
    dismissBtn.addEventListener('click', function(e){
      e.stopPropagation();
      try{ localStorage.setItem('crx_donate_dismiss', JSON.stringify({ expiry: Date.now() + 7*24*60*60*1000 })); }catch(e){}
      if(btn) btn.style.display='none';
      const label = document.getElementById('crx_floating_label'); if(label) label.style.display='none';
    });
  }

  // rest of floating show logic left as before — you can keep it or re-add if needed.
});
</script>
