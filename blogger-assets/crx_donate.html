<!-- Gadget-ready crx_donate (paste into Blog gadget HTML box) -->
<div class="crx-gadget-anchor"></div>
<h1>Hello</h1>
<script>
(function(){
  'use strict';

  // Create a per-instance unique id
  function uid(prefix='crx'){
    return prefix + '-' + Math.random().toString(36).slice(2,9);
  }

  // Default configuration (you can override by placing a JSON object on the anchor element: data-crx-config)
  const defaultConfig = {
    upi: 'champaksworld-1@hdfcbank',
    name: 'Champak Roy',
    qr: 'https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg',
    title: 'Support Learning Sutras — small donations, big impact',
    desc: 'If this post helped you, please consider supporting my writing. Copy the UPI ID or open the QR — thank you ❤️'
  };

  // Find each anchor and init a widget there (supports multiple gadget anchors)
  const anchors = Array.from(document.querySelectorAll('.crx-gadget-anchor') || []);
  anchors.forEach(initWidgetOnAnchor);

  function initWidgetOnAnchor(anchorEl){
    // config may be stored as JSON in data-crx-config attribute on anchor
    let config = Object.assign({}, defaultConfig);
    try {
      const raw = anchorEl.getAttribute('data-crx-config');
      if(raw){
        const parsed = JSON.parse(raw);
        config = Object.assign(config, parsed);
      }
    } catch(e){
      console.warn('[crx-gadget] invalid data-crx-config, ignoring', e);
    }

    // Build UI inside a shadow root to avoid CSS clash
    const host = document.createElement('div');
    const sid = uid('donate');
    host.setAttribute('role','region');
    host.setAttribute('aria-label','Support this blog - donate');
    host.id = sid;

    // attach shadow root (if available) or use host as root
    const sr = (host.attachShadow && typeof host.attachShadow === 'function') ? host.attachShadow({mode:'open'}) : null;
    const root = sr || host; // if shadow not supported, fallback to host

    // create style (scoped to shadow)
    const style = document.createElement('style');
    style.textContent = `
      :host{font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;display:block;max-width:520px;margin:12px 0;}
      .card{padding:12px;border-radius:12px;box-shadow:0 6px 18px rgba(11,12,16,0.06);background:linear-gradient(180deg,#fff,#fbfdff);display:flex;gap:12px;align-items:center;}
      .qr{width:110px;height:110px;border-radius:8px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0;}
      .qr img{width:100%;height:100%;object-fit:contain;display:block}
      .meta{flex:1;min-width:0}
      .title{font-weight:800;font-size:17px;color:#071022;margin-bottom:6px}
      .desc{font-size:14px;color:#6b7280;line-height:1.35;margin-bottom:8px}
      .actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
      .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:10px;font-weight:700;border:1px solid rgba(0,0,0,0.06);cursor:pointer;background:#fff;color:#071022;text-decoration:none}
      .btn:focus{outline:none;box-shadow:0 0 0 4px rgba(11,94,215,0.12)}
      .primary{background:#0b84ff;color:#fff;border:0}
      .share{background:#eef6ff;border:0;color:#064e9c}
      .upiRow{margin-top:8px;display:flex;gap:8px;align-items:center;font-weight:700;color:#0b84ff;word-break:break-all}
      .upiText{font-size:13px;color:#071022;background:#f8fafc;padding:6px 8px;border-radius:8px;border:1px solid rgba(6,12,22,0.04);display:flex;gap:8px;align-items:center}
      .smallBtn{background:transparent;border:0;cursor:pointer;padding:6px;border-radius:6px;font-weight:700;color:#0b84ff}
      .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;background:rgba(6,12,22,0.92);color:#fff;padding:10px 14px;border-radius:8px;font-weight:700;font-size:13px;box-shadow:0 8px 24px rgba(6,12,22,0.24);opacity:0;pointer-events:none;transition:opacity .18s ease,transform .18s ease}
      .toast.visible{opacity:1;pointer-events:auto;transform:translateX(-50%) translateY(-6px)}
      @media (max-width:520px){ .qr{width:96px;height:96px} :host{max-width:96%} }
    `;

    // build markup
    const card = document.createElement('div'); card.className = 'card';
    const qr = document.createElement('div'); qr.className = 'qr'; qr.setAttribute('aria-hidden','false');
    const img = document.createElement('img');
    img.src = config.qr || defaultConfig.qr;
    img.alt = 'QR code to donate';
    img.loading='lazy';
    img.decoding='async';
    img.width=110;
    img.height=110;
    // fallback on image error
    img.addEventListener('error', function(){ try { img.src = defaultConfig.qr; } catch(e){} });

    qr.appendChild(img);

    const meta = document.createElement('div'); meta.className = 'meta';
    const title = document.createElement('div'); title.className = 'title'; title.textContent = config.title || defaultConfig.title;
    const desc = document.createElement('div'); desc.className = 'desc'; desc.textContent = config.desc || defaultConfig.desc;

    const actions = document.createElement('div'); actions.className = 'actions'; actions.setAttribute('role','group'); actions.setAttribute('aria-label','Donation actions');

    const btnCopy = document.createElement('button');
    btnCopy.className='btn primary';
    btnCopy.type='button';
    btnCopy.textContent='Copy UPI ID';
    btnCopy.setAttribute('aria-label','Copy UPI ID to clipboard');

    const btnShare = document.createElement('button');
    btnShare.className='btn share';
    btnShare.type='button';
    btnShare.textContent='Share';
    btnShare.setAttribute('aria-label','Share donation details');

    const btnOpen = document.createElement('a');
    btnOpen.className='btn';
    btnOpen.href = config.qr || defaultConfig.qr;
    btnOpen.target='_blank';
    btnOpen.rel='noopener noreferrer nofollow';
    btnOpen.textContent='Open QR — Save/Scan';
    btnOpen.setAttribute('aria-label','Open QR in new tab');

    actions.appendChild(btnCopy);
    actions.appendChild(btnShare);
    actions.appendChild(btnOpen);

    const upiRow = document.createElement('div'); upiRow.className='upiRow';
    const upiLabel = document.createElement('div'); upiLabel.style.fontSize='13px'; upiLabel.style.color='#6b7280'; upiLabel.textContent = 'UPI ID:';
    const upiTextWrap = document.createElement('div'); upiTextWrap.className='upiText'; upiTextWrap.setAttribute('role','text'); upiTextWrap.setAttribute('aria-live','polite');
    const upiValue = document.createElement('span'); upiValue.textContent = config.upi || defaultConfig.upi;
    const btnCopySmall = document.createElement('button'); btnCopySmall.className='smallBtn'; btnCopySmall.type='button'; btnCopySmall.title='Copy UPI ID'; btnCopySmall.textContent='Copy';
    btnCopySmall.setAttribute('aria-label','Copy UPI ID');

    upiTextWrap.appendChild(upiValue);
    upiTextWrap.appendChild(btnCopySmall);
    upiRow.appendChild(upiLabel);
    upiRow.appendChild(upiTextWrap);

    meta.appendChild(title);
    meta.appendChild(desc);
    meta.appendChild(actions);
    meta.appendChild(upiRow);

    card.appendChild(qr);
    card.appendChild(meta);

    // attach everything to shadow / root
    try { root.appendChild(style); } catch(e){ console.warn('append style failed', e); }
    try { root.appendChild(card); } catch(e){ console.warn('append card failed', e); }

    // create a toast element once on document body (global to page) to preserve visual position
    let toast = document.getElementById('crx-global-toast');
    if(!toast){
      toast = document.createElement('div');
      toast.id = 'crx-global-toast';
      toast.className='toast';
      toast.setAttribute('role','status');
      toast.setAttribute('aria-live','polite');
      // ensure non-shadow to appear above content
      try { document.body.appendChild(toast); } catch(e){ /* if body unavailable, append to root */ if (root && root.appendChild) root.appendChild(toast); }
    }

    // small helper functions
    function showToast(msg, ms=1600){
      try {
        toast.textContent = msg;
        toast.classList.add('visible');
        clearTimeout((toast._t||0));
        toast._t = setTimeout(()=> toast.classList.remove('visible'), ms);
      } catch(e){ console.warn('toast error', e); }
    }

    async function copyText(text){
      text = (typeof text === 'string') ? text : String(text);
      if(navigator.clipboard && navigator.clipboard.writeText){
        try { await navigator.clipboard.writeText(text); return true; } catch(e){ /* fallback */ }
      }
      try {
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.setAttribute('readonly','');
         
        document.body.appendChild(ta);
        ta.select();
        ta.setSelectionRange(0, ta.value.length);
        const ok = document.execCommand('copy');
        document.body.removeChild(ta);
        return !!ok;
      } catch(e){ return false; }
    }

    function selectNodeText(node){
      try {
        const r = document.createRange();
        r.selectNodeContents(node);
        const s = window.getSelection();
        s.removeAllRanges();
        s.addRange(r);
      } catch(e){ console.warn('selectNodeText failed', e); }
    }

    // Attach event listeners (per instance)
    btnCopy.addEventListener('click', async function(e){
      const ok = await copyText(upiValue.textContent || config.upi || defaultConfig.upi);
      if(ok){
        showToast('UPI ID copied to clipboard');
        if(window.crxDonateOnAction) try { window.crxDonateOnAction('copy_upi',{upi:upiValue.textContent}); } catch(e){}
      } else {
        showToast('Copy failed — select UPI and copy manually',2400);
        selectNodeText(upiValue);
        if(window.crxDonateOnAction) try { window.crxDonateOnAction('copy_fail',{}); } catch(e){}
      }
    });

    btnCopySmall.addEventListener('click', async function(){
      const ok = await copyText(upiValue.textContent || config.upi || defaultConfig.upi);
      if(ok){
        showToast('UPI ID copied');
        if(window.crxDonateOnAction) try { window.crxDonateOnAction('copy_upi_small',{upi:upiValue.textContent}); } catch(e){}
      } else {
        showToast('Copy failed');
        selectNodeText(upiValue);
      }
    });

    btnShare.addEventListener('click', async function(){
      const pageUrl = (typeof location !== 'undefined' && location.href) ? location.href : '';
      const msg = `Support ${config.name || defaultConfig.name}\nUPI ID: ${upiValue.textContent || config.upi || defaultConfig.upi}${pageUrl ? '\nPost: ' + pageUrl : ''}`;
      if(navigator.share){
        try {
          await navigator.share({title:`Support ${config.name || defaultConfig.name}`, text: msg, url: pageUrl || undefined});
          showToast('Share sheet opened');
          if(window.crxDonateOnAction) try { window.crxDonateOnAction('share_native',{}); } catch(e){}
          return;
        } catch(e){ /* fallback below */ }
      }
      const ok = await copyText(msg);
      if(ok){
        showToast('Share text copied — paste to share');
        if(window.crxDonateOnAction) try { window.crxDonateOnAction('share_copy',{}); } catch(e){}
      } else {
        showToast('Share failed — copy UPI ID manually');
        selectNodeText(upiValue);
      }
    });

    // insert the host in place of anchor; fallback append to body
    try {
      if(anchorEl && anchorEl.parentNode){
        anchorEl.parentNode.replaceChild(host, anchorEl);
      } else {
        document.body.appendChild(host);
      }
    } catch(e){
      // fallback: try append
      try { document.body.appendChild(host); } catch(err) { console.warn('Failed to insert donate widget', err); }
    }

    // expose a per-instance handle for debugging if needed
    host._crxInstance = { config, upiValue, showToast };

  } // initWidgetOnAnchor

})();
</script>
<!-- End crx_donate -->
