<!-- crx_donate.html - Improved fallback: detect deep-link failure & show explicit fallbacks -->
<div class="crx_donate_card" role="region" aria-label="Support this blog - donate" id="crx_donate_fragment">
  <style>
    .crx_donate_card{ font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial; max-width:520px; margin:12px 0; padding:12px; border-radius:12px; box-shadow:0 6px 18px rgba(11,12,16,0.06); background:linear-gradient(180deg,#ffffff,#fbfdff); display:flex; gap:12px; align-items:center; }
    .crx_donate_qr{ width:110px; height:110px; border-radius:8px; background:#f3f4f6; display:flex; align-items:center; justify-content:center; overflow:hidden; flex-shrink:0; }
    .crx_donate_qr img{ width:100%; height:100%; object-fit:contain; display:block; }
    .crx_donate_meta{ flex:1; min-width:0; }
    .crx_donate_title{ font-size:17px; font-weight:800; margin-bottom:6px; color:#071022; }
    .crx_donate_desc{ font-size:14px; color:#6b7280; line-height:1.35; margin-bottom:8px; }
    .crx_donate_benefits{ font-size:13px; color:#39404a; margin-bottom:10px; }
    .crx_action_row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .crx_btn{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:10px; text-decoration:none; font-weight:700; border:1px solid rgba(0,0,0,0.06); cursor:pointer; background:#fff; color:#071022; }
    .crx_primary{ background:#0b84ff; color:#fff; box-shadow:0 8px 20px rgba(11,132,255,0.12); }
    .crx_preset{ display:inline-flex; text-decoration:none; align-items:center; justify-content:center; background:#f4f7fb; padding:8px 10px; border-radius:8px; font-weight:800; color:#071022; border:0; cursor:pointer; }
    .crx_small_hint{ font-size:12px; color:#6b7280; margin-top:8px; }
    .crx_donate_smallprint{ font-size:12px; color:#6b7280; margin-top:8px; }
    #crx_helper{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; z-index:10020; background:#fff; color:#071022; padding:12px 14px; border-radius:12px; box-shadow:0 10px 30px rgba(2,6,23,0.12); display:none; font-weight:700; max-width:92%; min-width:260px; text-align:center;}
    #crx_helper p{ margin:0 0 8px 0; font-size:14px; font-weight:700; color:#071022; }
    #crx_helper .crx_actions{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    #crx_helper .crx_actions button, #crx_helper .crx_actions a{ padding:8px 10px; border-radius:8px; border:0; cursor:pointer; font-weight:700; }
    #crx_helper .open-qr{ background:#eef2ff; color:#0b84ff; }
    #crx_helper .copy-upi{ background:#0b84ff; color:#fff; }
    #crx_helper .open-browser{ background:#f3f4f6; color:#071022; }
    #crx_upi_text{ font-weight:800; color:#071022; display:block; margin-top:6px; font-size:13px; }
    @media (max-width:520px){ .crx_donate_card{ max-width:96%; } .crx_donate_qr{ width:96px; height:96px; } #crx_helper{ min-width:220px; } }
  </style>

  <div class="crx_donate_qr" aria-hidden="false">
    <img id="crx_qr_image" src="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg" alt="QR code to donate" loading="lazy" decoding="async" width="110" height="110" />
  </div>

  <div class="crx_donate_meta">
    <div class="crx_donate_title">Support Learning Sutras — small donations, big impact</div>
    <div class="crx_donate_desc">If this post helped you, please consider supporting my writing. Choose a quick amount or open the QR — thank you ❤️</div>

    <div class="crx_donate_benefits">Quick options — keeps tools free, fewer ads, and funds new tutorials.</div>

    <div class="crx_action_row" role="group" aria-label="Donation actions">
      <!-- Use href -> QR fallback (desktop safe). data-upi contains the UPI link to attempt on mobile -->
      <a id="crx_pay_now" class="crx_btn crx_primary"
         href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg"
         data-upi="upi://pay?pa=9335874326%40kotak811&pn=Champak%20Roy&am=50&cu=INR"
         rel="noopener" aria-label="Donate ₹50 now">Donate ₹50</a>

      <!-- Preset anchors (href -> QR fallback; data-upi -> deep link attempted on mobile) -->
<a class="crx_preset" href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg"
         data-upi="upi://pay?pa=9335874326%40kotak811&pn=Champak%20Roy&am=1&cu=INR" data-amount="1" aria-label="Donate ₹1">₹1</a>


      <a class="crx_preset" href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg"
         data-upi="upi://pay?pa=9335874326%40kotak811&pn=Champak%20Roy&am=20&cu=INR" data-amount="20" aria-label="Donate ₹20">₹20</a>
 
      <a class="crx_preset" href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg"
         data-upi="upi://pay?pa=9335874326%40kotak811&pn=Champak%20Roy&am=50&cu=INR" data-amount="50" aria-label="Donate ₹50">₹50</a>

      <a class="crx_preset" href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg"
         data-upi="upi://pay?pa=9335874326%40kotak811&pn=Champak%20Roy&am=100&cu=INR" data-amount="100" aria-label="Donate ₹100">₹100</a>

      <a class="crx_preset" href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg"
         data-upi="upi://pay?pa=9335874326%40kotak811&pn=Champak%20Roy&am=250&cu=INR" data-amount="250" aria-label="Donate ₹250">₹250</a>

      <a id="crx_open_qr" class="crx_btn" href="https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg" target="_blank" rel="noopener noreferrer">Open QR — Save/Scan</a>
    </div>

    <div class="crx_small_hint">Tip: on mobile, tapping a Donate link should open your UPI app. If it doesn't, use the helper to copy UPI or scan the QR.</div>
    <div class="crx_donate_smallprint">You’ll stay anonymous unless you choose to share details. Thanks — Champak Roy</div>
  </div>
</div>

<div id="crx_helper" role="dialog" aria-live="polite" aria-hidden="true">
  <p id="crx_helper_msg">Couldn't complete the one-tap payment — try scanning the QR or copy the UPI ID.</p>
  <span id="crx_upi_text"></span>
  <div class="crx_actions" style="margin-top:8px;">
    <button class="open-qr" id="crx_helper_openqr">Open QR</button>
    <button class="copy-upi" id="crx_helper_copy">Copy UPI</button>
    <button class="open-browser" id="crx_helper_openbrowser">Open in browser</button>
  </div>
</div>

<!-- Floating button etc. (keeps your existing styles/behavior) -->
<style>
#crx_floating_donate{ position:fixed; z-index:9998; --size:64px; width:var(--size); height:var(--size); border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 30px rgba(3,10,30,0.18); background:linear-gradient(180deg,#0b84ff,#0466d7); color:white; font-weight:700; cursor:pointer; border:0; transition:transform 350ms ease, opacity 300ms ease, right 1s ease, left 1s ease, bottom 1s ease, top 1s ease; opacity:0; pointer-events:none; }
#crx_floating_donate.visible{ opacity:1; pointer-events:auto; }
#crx_floating_label{ position:fixed; z-index:9997; background:#fff; color:#071022; padding:8px 10px; border-radius:8px; box-shadow:0 8px 20px rgba(6,12,22,0.12); font-weight:700; font-size:13px; transition:opacity 200ms, transform 200ms; opacity:0; pointer-events:none; }
#crx_floating_donate:hover + #crx_floating_label, #crx_floating_donate:focus + #crx_floating_label{ opacity:1; transform:translateY(-6px); }
#crx_floating_dismiss{ position:absolute; right:-8px; top:-8px; width:22px; height:22px; border-radius:50%; background:rgba(0,0,0,0.12); color:#fff; font-size:12px; display:flex; align-items:center; justify-content:center; border:0; transition:opacity .15s; }
#crx_floating_donate:hover #crx_floating_dismiss{ opacity:1; }
@media (prefers-reduced-motion: reduce){ #crx_floating_donate, #crx_floating_label{ transition:none!important; } }
</style>

<button id="crx_floating_donate" aria-label="Donate — open UPI or QR" title="Donate — open UPI or QR" aria-haspopup="dialog" type="button">
  Donate
  <button id="crx_floating_dismiss" aria-label="Close donate button" title="Close" type="button">✕</button>
</button>
<div id="crx_floating_label" role="status" aria-live="polite">Donate via UPI</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // Centralized QR (src of #crx_qr_image) used as fallback
  const qrEl = document.getElementById('crx_qr_image');
  const QR = qrEl ? qrEl.src : 'https://varanasi-software-junction.github.io/blogger/blogger-assets/qr.jpg';

  const presetAnchors = Array.from(document.querySelectorAll('.crx_preset'));
  const payNow = document.getElementById('crx_pay_now');
  const openQr = document.getElementById('crx_open_qr');
  const helper = document.getElementById('crx_helper');
  const helperMsg = document.getElementById('crx_helper_msg');
  const helperUpiText = document.getElementById('crx_upi_text');
  const helperOpenQrBtn = document.getElementById('crx_helper_openqr');
  const helperCopyBtn = document.getElementById('crx_helper_copy');
  const helperOpenBrowser = document.getElementById('crx_helper_openbrowser');
  const btn = document.getElementById('crx_floating_donate');
  const dismissBtn = document.getElementById('crx_floating_dismiss');

  // extract UPI pa param from data-upi (first available)
  function extractPa(uri){
    if(!uri) return '';
    try {
      const q = uri.split('?')[1] || '';
      const params = new URLSearchParams(q);
      return decodeURIComponent(params.get('pa') || '');
    } catch(e){ return ''; }
  }
  const source = payNow || document.querySelector('[data-upi]');
  const detectedPa = source ? extractPa(source.getAttribute('data-upi') || source.getAttribute('href')) : '';
  if(helperUpiText) helperUpiText.textContent = detectedPa || '';

  // detect mobile
  const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  // Try deep-link and detect failure. Returns a Promise that resolves true if looks like success (user left page)
  function attemptDeepLink(upiUri, timeout = 1200){
    return new Promise((resolve) => {
      let left = false;
      const onVisibility = () => { if(document.visibilityState !== 'visible') left = true; };
      document.addEventListener('visibilitychange', onVisibility);

      // Primary attempt
      try { window.location.href = upiUri; } catch(e){}

      // Also try anchor-click attempt (some browsers require gesture)
      try {
        const a = document.createElement('a'); a.href = upiUri; a.style.display='none'; document.body.appendChild(a); a.click();
        setTimeout(()=>{ try{ document.body.removeChild(a); }catch(e){} }, 1000);
      } catch(e){}

      // iframe fallback after small delay
      setTimeout(()=> {
        try {
          const iframe = document.createElement('iframe');
          iframe.style.display = 'none';
          iframe.src = upiUri;
          document.body.appendChild(iframe);
          setTimeout(()=> { try{ document.body.removeChild(iframe); }catch(e){} }, 1000);
        } catch(e){}
      }, 400);

      setTimeout(()=> {
        document.removeEventListener('visibilitychange', onVisibility);
        resolve(left);
      }, timeout);
    });
  }

  // show helper with message
  function showHelper(message){
    if(helper){
      helperMsg.textContent = message || 'Couldn\'t complete the one-tap payment — try scanning the QR or copy the UPI ID.';
      // ensure helperUpiText already populated
      helper.setAttribute('aria-hidden','false');
      helper.style.display = 'block';
    }
  }
  function hideHelper(){
    if(helper){ helper.style.display = 'none'; helper.setAttribute('aria-hidden','true'); }
  }

  // copy to clipboard helper
  function copyText(text){
    if(!text) return;
    if(navigator.clipboard && navigator.clipboard.writeText){
      return navigator.clipboard.writeText(text);
    } else {
      return new Promise((res) => {
        const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta); ta.select();
        try{ document.execCommand('copy'); }catch(e){ /* ignore */ }
        document.body.removeChild(ta);
        res();
      });
    }
  }

  // universal handler for donate anchors
  function handleAnchor(anchor){
    if(!anchor) return;
    anchor.addEventListener('click', async function(e){
      const upi = anchor.getAttribute('data-upi') || anchor.getAttribute('href');
      if(!upi) return;
      // On mobile: attempt deep-link and detect whether the user left the page
      if(isMobile){
        e.preventDefault();
        hideHelper(); // hide previous helper
        const started = await attemptDeepLink(upi, 1200);
        if(started){
          // looks like the user left the page and the UPI app likely opened.
          // nothing else to do.
          return;
        } else {
          // deep-link didn't start (browser blocked or bank rejected). show helper + fallback.
          showHelper('Couldn\'t start the one-tap payment — try scanning the QR or copy the UPI ID. If you are in an app (WhatsApp/Facebook), open this page in Chrome/Safari.');
          // open QR in new tab so user can scan easily
          try { window.open(QR, '_blank', 'noopener'); } catch(e){}
        }
      } else {
        // Desktop: open QR image (href already points to QR, but ensure no scheme error)
        e.preventDefault();
        try { window.open(QR, '_blank', 'noopener'); } catch(e){}
      }
    });
  }

  // Attach handlers
  handleAnchor(payNow);
  presetAnchors.forEach(a => handleAnchor(a));
  if(openQr){
    openQr.addEventListener('click', function(){ hideHelper(); try{ window.open(QR, '_blank', 'noopener'); }catch(e){} });
  }

  // helper action buttons
  if(helperOpenQrBtn){
    helperOpenQrBtn.addEventListener('click', function(){
      try{ window.open(QR, '_blank', 'noopener'); }catch(e){}
    });
  }
  if(helperCopyBtn){
    helperCopyBtn.addEventListener('click', function(){
      const text = detectedPa || helperUpiText.textContent || '';
      copyText(text).then(()=> {
        helperCopyBtn.textContent = 'Copied';
        setTimeout(()=> helperCopyBtn.textContent = 'Copy UPI', 1600);
      });
    });
  }
  if(helperOpenBrowser){
    helperOpenBrowser.addEventListener('click', function(){
      // This attempts to open the page in a new tab/window which user can then open in system browser.
      // Note: in-app webviews may block opening new tabs; still helpful in many cases.
      try {
        const openInNew = window.open(location.href, '_blank', 'noopener');
        if(!openInNew) {
          // popup blocked: show short instruction
          showHelper('Tap the browser menu and choose "Open in browser" (or open this page in Chrome/Safari).');
        } else {
          openInNew.focus();
        }
      } catch(e){
        showHelper('Open this page in Chrome/Safari to complete the one-tap payment.');
      }
    });
  }

  // Floating button triggers the primary anchor (preserves behavior)
  const floating = document.getElementById('crx_floating_donate');
  if(floating){
    floating.addEventListener('click', function(e){
      if(e.target && e.target.id === 'crx_floating_dismiss') return;
      if(payNow){
        payNow.click();
      } else {
        try{ window.open(QR, '_blank', 'noopener'); }catch(e){}
      }
    });
  }

  // Dismiss handler on floating (if present) to hide floating for days
  const dismissBtn = document.getElementById('crx_floating_dismiss');
  if(dismissBtn){
    dismissBtn.addEventListener('click', function(e){
      e.stopPropagation();
      try{ localStorage.setItem('crx_donate_dismiss', JSON.stringify({ expiry: Date.now() + 7*24*60*60*1000 })); }catch(e){}
      const floatBtn = document.getElementById('crx_floating_donate'); if(floatBtn) floatBtn.style.display='none';
      const label = document.getElementById('crx_floating_label'); if(label) label.style.display='none';
    });
  }

  // existing floating show logic (keeps your prior rules)
  (function floatingSetup(){
    const config = {
      bigTimeSeconds: 120,
      initialDelay: 30,
      showOnScrollPercent: 60,
      maxShowsPerSession: 3,
      coolDownBetweenShows: 60,
      sessionKey: 'crx_donate_session',
      donatedKey: 'crx_donate_done'
    };
    const readJSON = (k,useSession=false)=>{ try{ const s=(useSession?sessionStorage:localStorage).getItem(k); return s?JSON.parse(s):null;}catch(e){return null;} };
    const writeJSON = (k,v,useSession=false)=>{ try{ (useSession?sessionStorage:localStorage).setItem(k, JSON.stringify(v)); }catch(e){} };
    let session = readJSON(config.sessionKey, true) || { showCount:0, lastShown:0, firstSeen: Date.now() };
    const hasDonated = !!localStorage.getItem(config.donatedKey);
    const dismissedFlag = (()=>{ const d=readJSON('crx_donate_dismiss'); return d && Date.now()<d.expiry; })();
    if(!floating || hasDonated || dismissedFlag) return;

    const corners=['br','bl','tl','tr']; let currentCornerIndex=0; const margin=16;
    function placeCorner(corner){
      const btn = document.getElementById('crx_floating_donate');
      const label = document.getElementById('crx_floating_label');
      if(!btn) return;
      btn.style.right=btn.style.left=btn.style.top=btn.style.bottom='';
      if(label) label.style.right=label.style.left=label.style.top=label.style.bottom='';
      const offset = margin + 'px';
      switch(corner){
        case 'br': btn.style.right = offset; btn.style.bottom = offset; if(label) label.style.right = `calc(${offset} + 80px)`; if(label) label.style.bottom = offset; break;
        case 'bl': btn.style.left = offset; btn.style.bottom = offset; if(label) label.style.left = `calc(${offset} + 80px)`; if(label) label.style.bottom = offset; break;
        case 'tl': btn.style.left = offset; btn.style.top = offset; if(label) label.style.left = `calc(${offset} + 80px)`; if(label) label.style.top = offset; break;
        case 'tr': btn.style.right = offset; btn.style.top = offset; if(label) label.style.right = `calc(${offset} + 80px)`; if(label) label.style.top = offset; break;
      }
    }
    let visible=false; let moveInterval=null;
    function showFloating(){
      if(visible) return;
      const sinceLast = Math.floor((Date.now() - (session.lastShown || 0))/1000);
      if(session.showCount >= config.maxShowsPerSession) return;
      if(session.lastShown && sinceLast < config.coolDownBetweenShows) return;
      session.showCount = (session.showCount||0) + 1;
      session.lastShown = Date.now();
      try{ sessionStorage.setItem(config.sessionKey, JSON.stringify(session)); }catch(e){}
      placeCorner(corners[currentCornerIndex % corners.length]);
      floating.classList.add('visible'); const label = document.getElementById('crx_floating_label'); if(label) label.classList.add('visible'); visible=true;
      if(!window.matchMedia('(prefers-reduced-motion: reduce)').matches){
        moveInterval = setInterval(()=> {
          if(floating.matches(':hover') || document.activeElement === floating) return;
          currentCornerIndex = (currentCornerIndex + 1) % corners.length;
          placeCorner(corners[currentCornerIndex]);
        }, 10000);
      }
    }
    function hideFloating(){
      if(!visible) return;
      floating.classList.remove('visible'); const label = document.getElementById('crx_floating_label'); if(label) label.classList.remove('visible'); visible=false;
      if(moveInterval){ clearInterval(moveInterval); moveInterval=null; }
    }
    let start = Date.now();
    setInterval(()=> {
      const secs = Math.floor((Date.now()-start)/1000);
      const doc=document.documentElement; const scrollTop=(window.pageYOffset||doc.scrollTop)-(doc.clientTop||0); const height=Math.max(doc.scrollHeight-doc.clientHeight,1);
      const scrolledPercent = Math.min(100, Math.round(100*scrollTop/height));
      if(!visible && (secs >= 120 || (secs >= 30 && scrolledPercent >= 60))) showFloating();
    }, 1000);
    document.addEventListener('click', function(e){
      const t = e.target.closest && e.target.closest('.crx_btn, .crx_preset, #crx_open_qr, #crx_pay_now');
      if(t) hideFloating();
    });
  })();

  // Expose helper: mark donated
  window.crxMarkDonated = function(){ try{ localStorage.setItem('crx_donate_done', '1'); }catch(e){} const frag = document.getElementById('crx_donate_fragment'); if(frag) frag.style.display='none'; const floatBtn = document.getElementById('crx_floating_donate'); if(floatBtn) floatBtn.style.display='none'; };
});
</script>
